<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SheetRocket - Cloud Editor</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <style>
        :root {
            --editor-bg: #1e1e1e;
            --editor-text: #d4d4d4;
            --border-color: #343a40;
        }

        body {
            background-color: #212529;
            font-family: 'Inter', sans-serif;
            height: 100vh;
            overflow: hidden;
            display: none; /* Disembunyikan saat inisialisasi */
            flex-direction: column;
            color: #f8f9fa;
        }

        /* Navbar Customization */
        .navbar {
            background-color: #1a1d20 !important;
            border-bottom: 1px solid var(--border-color);
            padding: 0.75rem 1.5rem;
            flex-shrink: 0;
        }

        .brand-icon {
            width: 40px;
            height: 40px;
            /* Gradient combining Green (Sheets) and Blue/Cyan (Sky/Rocket) */
            background: linear-gradient(135deg, #198754, #0dcaf0); 
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: 0 0 15px rgba(13, 202, 240, 0.3);
        }

        /* Main Layout */
        .workspace {
            flex: 1;
            display: flex;
            overflow: hidden;
            position: relative;
        }

        .pane {
            width: 50%;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .editor-pane {
            background-color: var(--editor-bg);
            border-right: 1px solid var(--border-color);
        }

        .preview-pane {
            background-color: #f0f2f5; /* Light gray for contrast with device frames */
        }

        /* Pane Header */
        .pane-header {
            padding: 8px 16px;
            font-size: 0.85rem;
            font-family: 'JetBrains Mono', monospace;
            color: #adb5bd;
            background-color: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 45px;
        }

        .preview-pane .pane-header {
            background-color: #fff;
            color: #6c757d;
            border-bottom: 1px solid #dee2e6;
        }

        /* Editor Area */
        #code-editor {
            flex: 1;
            width: 100%;
            background-color: var(--editor-bg);
            color: var(--editor-text);
            border: none;
            resize: none;
            padding: 1.5rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            line-height: 1.6;
            outline: none;
        }

        #code-editor::placeholder {
            color: #6c757d;
        }

        /* Preview Container & Iframe */
        .preview-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            overflow: hidden;
            padding: 20px;
            background-color: #e9ecef;
            position: relative;
        }

        iframe {
            background: white;
            border: none;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            transition: width 0.3s ease, height 0.3s ease;
            width: 100%;
            height: 100%;
        }

        /* Device Modes */
        .device-mobile {
            width: 375px !important;
            height: 100% !important;
            border-radius: 8px;
            border: 8px solid #333;
        }

        .device-tablet {
            width: 768px !important;
            height: 100% !important;
            border-radius: 8px;
            border: 8px solid #333;
        }

        .device-desktop {
            width: 100% !important;
            height: 100% !important;
            border: none;
            border-radius: 0;
        }

        /* Loading Overlay */
        #loading-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #212529;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            color: white;
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
            margin-bottom: 1rem;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .workspace {
                flex-direction: column;
            }
            .pane {
                width: 100%;
                height: 50%;
            }
            .editor-pane {
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }
            .preview-container {
                padding: 0;
            }
            /* Disable device preview on mobile screens */
            .device-controls {
                display: none !important;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        ::-webkit-scrollbar-track {
            background: var(--editor-bg);
        }
        ::-webkit-scrollbar-thumb {
            background: #495057;
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6c757d;
        }
        
        .autosave-indicator {
            font-size: 0.75rem;
            color: #6c757d;
            transition: color 0.3s;
        }
        .autosave-indicator.saving {
            color: #ffc107;
        }
        .autosave-indicator.saved {
            color: #198754;
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "lucide-react": "https://esm.sh/lucide-react@^0.562.0",
    "react/": "https://esm.sh/react@^19.2.3/",
    "@google/genai": "https://esm.sh/@google/genai@^1.34.0"
  }
}
</script>
</head>
<body>

    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="spinner-border text-info" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <h5 id="loading-text">Connecting to SheetRocket...</h5>
    </div>

    <!-- Header -->
    <nav class="navbar navbar-dark">
        <div class="container-fluid p-0">
            <div class="d-flex align-items-center gap-3">
                <div class="brand-icon">
                    <!-- Rocket Icon for the new Brand -->
                    <i class="bi bi-rocket-takeoff-fill fs-5"></i>
                </div>
                <div>
                    <h6 class="m-0 fw-bold text-white text-uppercase" style="letter-spacing: 0.5px;">SheetRocket <span class="badge bg-secondary bg-opacity-50 border border-secondary border-opacity-50 ms-2" style="font-size: 0.6em; vertical-align: middle;">GITHUB EDITION</span></h6>
                    <small class="text-secondary" style="font-size: 11px;" id="project-status">Powered by Google Sheets API</small>
                </div>
            </div>
            
            <div class="d-flex gap-2">
                <button onclick="saveToCloud()" class="btn btn-success btn-sm d-flex align-items-center gap-2 shadow-sm" id="btn-save" title="Save to Google Sheets">
                    <i class="bi bi-cloud-check-fill"></i> <span class="d-none d-sm-inline">Save</span>
                </button>
                <div class="vr bg-secondary mx-1 opacity-25"></div>
                <button onclick="deployPage()" class="btn btn-outline-info btn-sm d-flex align-items-center gap-2 text-white" title="Open View Mode">
                    <i class="bi bi-window-fullscreen"></i> <span class="d-none d-sm-inline">Deploy</span>
                </button>
                <button onclick="shareLink()" class="btn btn-primary btn-sm d-flex align-items-center gap-2 shadow-sm" title="Share URL">
                    <i class="bi bi-share-fill"></i> Share
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Workspace -->
    <div class="workspace">
        <!-- Editor Column -->
        <div class="pane editor-pane">
            <div class="pane-header">
                <div class="d-flex align-items-center gap-2">
                    <i class="bi bi-filetype-html"></i>
                    <span>index.html</span>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <span id="autosave-status" class="autosave-indicator"><i class="bi bi-check2"></i> Local Saved</span>
                    <span id="char-count">0 chars</span>
                </div>
            </div>
            <textarea id="code-editor" spellcheck="false" placeholder="<!-- Start coding your masterpiece here... -->"></textarea>
        </div>

        <!-- Preview Column -->
        <div class="pane preview-pane">
            <div class="pane-header">
                <div class="d-flex align-items-center gap-2">
                    <span class="fw-bold"><i class="bi bi-eye-fill me-2"></i>Preview</span>
                    <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 d-flex align-items-center gap-1">
                        <i class="bi bi-circle-fill" style="font-size: 6px;"></i> Live
                    </span>
                </div>
                
                <!-- Device Controls -->
                <div class="btn-group btn-group-sm device-controls" role="group">
                    <button type="button" class="btn btn-outline-secondary active" onclick="setPreviewMode('desktop')" title="Desktop View">
                        <i class="bi bi-pc-display"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="setPreviewMode('tablet')" title="Tablet View">
                        <i class="bi bi-tablet"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="setPreviewMode('mobile')" title="Mobile View">
                        <i class="bi bi-phone"></i>
                    </button>
                </div>
            </div>
            <div class="preview-container">
                <iframe id="preview-frame" class="device-desktop" sandbox="allow-scripts allow-modals allow-forms allow-popups allow-same-origin"></iframe>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="position-fixed bottom-0 start-50 translate-middle-x p-3" style="z-index: 1050">
        <div id="toast-msg" class="toast align-items-center text-white bg-success border-0 shadow-lg" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body d-flex align-items-center gap-2" id="toast-body-text">
                    Action successful!
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- App Logic -->
    <script>
        // --- CONFIGURATION ---
        const APP_URL = "https://script.google.com/macros/s/AKfycbw_NrRwHRt_x8UlsQCKIddB6WXjA_kodlh77OliuuW5MeQMsdoNzUuDfVmvPx5NLlFk7g/exec";
        const AUTOSAVE_KEY = "sheetrocket_autosave_content";

        // --- GLOBAL VARIABLES ---
        let bsToast;
        let editor, preview, charCount, toastEl, toastBody, loadingOverlay, loadingText, projectStatus, autosaveStatus;
        let currentCloudId = null;
        let autosaveTimer;

        // --- UTILITIES ---
        const encode = (str) => {
            try { return btoa(unescape(encodeURIComponent(str))); } catch(e) { return ''; }
        };
        const decode = (hash) => {
            try { return decodeURIComponent(escape(atob(hash.replace(/^#/, '')))); } catch(e) { return ''; }
        };

        // --- CORE FUNCTIONS ---
        const updatePreview = () => {
            if (!editor) return;
            const code = editor.value;
            
            // Only update iframe if needed to prevent flashing, but for vanilla simple handling usually ok
            preview.srcdoc = code;
            charCount.textContent = code.length + ' chars';
            
            triggerAutosave();
        };

        const triggerAutosave = () => {
            if (autosaveStatus) {
                autosaveStatus.innerHTML = '<i class="bi bi-pencil-fill"></i> Typing...';
                autosaveStatus.className = 'autosave-indicator saving';
            }
            
            clearTimeout(autosaveTimer);
            autosaveTimer = setTimeout(() => {
                localStorage.setItem(AUTOSAVE_KEY, editor.value);
                if (autosaveStatus) {
                    autosaveStatus.innerHTML = '<i class="bi bi-check2"></i> Local Saved';
                    autosaveStatus.className = 'autosave-indicator saved';
                }
            }, 1000); // Save after 1 second of inactivity
        };

        const setPreviewMode = (mode) => {
            const frame = document.getElementById('preview-frame');
            frame.className = ''; // Reset classes
            
            // Update buttons state
            document.querySelectorAll('.device-controls .btn').forEach(btn => btn.classList.remove('active'));
            
            if (mode === 'mobile') {
                frame.classList.add('device-mobile');
                document.querySelector('[onclick="setPreviewMode(\'mobile\')"]').classList.add('active');
            } else if (mode === 'tablet') {
                frame.classList.add('device-tablet');
                document.querySelector('[onclick="setPreviewMode(\'tablet\')"]').classList.add('active');
            } else {
                frame.classList.add('device-desktop');
                document.querySelector('[onclick="setPreviewMode(\'desktop\')"]').classList.add('active');
            }
        };

        const showToast = (msg, isError = false) => {
            if (toastBody) toastBody.textContent = msg;
            if (toastEl) {
                toastEl.classList.remove('bg-success', 'bg-danger');
                toastEl.classList.add(isError ? 'bg-danger' : 'bg-success');
                if (bsToast) bsToast.show();
                else console.log("Toast:", msg);
            }
        };

        const showLoading = (msg) => {
            if (loadingText) loadingText.textContent = msg;
            if (loadingOverlay) loadingOverlay.style.display = 'flex';
        };

        const hideLoading = () => {
            if (loadingOverlay) loadingOverlay.style.display = 'none';
        };

        // --- GOOGLE SHEETS INTERACTION ---
        const saveToCloud = () => {
            const code = editor.value;
            const btn = document.getElementById('btn-save');
            const originalBtnText = btn.innerHTML;
            
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
            btn.disabled = true;

            const payload = JSON.stringify({
                action: 'save',
                html: code
            });

            fetch(APP_URL, {
                method: 'POST',
                mode: 'no-cors', 
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: payload
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    currentCloudId = data.id;
                    btn.innerHTML = originalBtnText;
                    btn.disabled = false;
                    projectStatus.textContent = "Saved to Sheet (ID: " + data.id + ")";
                    projectStatus.classList.add('text-success');
                    
                    const newUrl = updateQueryString('id', data.id);
                    window.history.pushState({path: newUrl}, '', newUrl);
                    showToast('Project saved to Google Sheets!');
                } else {
                    throw new Error(data.message || 'Unknown error');
                }
            })
            .catch(err => {
                btn.innerHTML = originalBtnText;
                btn.disabled = false;
                console.warn(err);
                // Attempt to notify user even if CORS blocks response reading
                showToast('Request sent. If ID does not appear, check CORS/Deployment.', true);
            });
        };

        const loadFromCloud = (id, isViewMode) => {
            showLoading("Fetching from Google Database...");
            const fetchUrl = `${APP_URL}?action=load&id=${id}`;

            fetch(fetchUrl)
            .then(response => response.json())
            .then(data => {
                 if (data.status === 'success') {
                    const content = data.content;
                    if (isViewMode) {
                        document.open();
                        document.write(content);
                        document.close();
                        hideLoading();
                    } else {
                        editor.value = content;
                        currentCloudId = id;
                        projectStatus.textContent = "Loaded from Sheet (ID: " + id + ")";
                        updatePreview();
                        hideLoading();
                        document.body.style.display = 'flex';
                    }
                } else {
                    throw new Error(data.message || 'Project not found');
                }
            })
            .catch(err => {
                hideLoading();
                console.error(err);
                if (!isViewMode) {
                    showToast("Failed to load: " + err.message, true);
                    editor.value = DEFAULT_CODE;
                    updatePreview();
                    document.body.style.display = 'flex';
                } else {
                    document.body.innerHTML = `<div style="color:white;text-align:center;padding:50px">Error: ${err.message}</div>`;
                    document.body.style.display = 'block';
                }
            });
        };

        // --- URL HELPERS ---
        const updateQueryString = (key, value) => {
            const url = new URL(window.location.href);
            url.searchParams.set(key, value);
            if(key === 'id') url.hash = ''; 
            return url.toString();
        };

        const getBaseUrl = () => {
            return window.location.href.split('?')[0].split('#')[0];
        };

        const shareLink = async () => {
            const baseUrl = getBaseUrl();
            let finalUrl = baseUrl;
            if (currentCloudId) {
                 finalUrl = `${baseUrl}?id=${currentCloudId}`;
            } else {
                const hash = encode(editor.value);
                finalUrl = `${baseUrl}#${hash}`;
                window.location.hash = hash;
            }
            try {
                await navigator.clipboard.writeText(finalUrl);
                showToast('Link copied!');
            } catch (err) {
                prompt("Copy this link:", finalUrl);
            }
        };

        const deployPage = () => {
            // Confirmation before deploy
            if (!confirm('Are you sure you want to deploy this page?')) {
                return;
            }

            const baseUrl = getBaseUrl();
            let url;
            if (currentCloudId) {
                url = `${baseUrl}?view=1&id=${currentCloudId}`;
            } else {
                const hash = encode(editor.value);
                url = `${baseUrl}?view=1#${hash}`;
            }
            window.open(url, '_blank');
        };

        // --- DEFAULT CODE ---
        const DEFAULT_CODE = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SheetRocket Page</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: linear-gradient(135deg, #f0f2f5 0%, #e9ecef 100%); display: flex; align-items: center; justify-content: center; min-height: 100vh; font-family: sans-serif; }
        .card { border: none; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-radius: 16px; overflow: hidden; }
        .card-header { background: white; border-bottom: 1px solid #f0f0f0; padding: 2rem; }
        .icon-box { width: 80px; height: 80px; background: linear-gradient(135deg, #198754, #0dcaf0); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; color: white; font-size: 2.5rem; }
    </style>
</head>
<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card text-center">
                    <div class="card-body p-5">
                        <div class="icon-box"><i class="bi bi-rocket-takeoff"></i></div>
                        <h2 class="fw-bold text-dark mb-3">Hello, SheetRocket!</h2>
                        <p class="text-secondary mb-4">This page is hosted on GitHub Pages but powered by Google Sheets!</p>
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary btn-lg rounded-pill" onclick="alert('Ready for liftoff!')">Launch Action</button>
                        </div>
                    </div>
                    <div class="card-footer bg-light p-3 text-muted small">
                        Built with Bootstrap 5 & Apps Script API
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Bootstrap Icons via CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
</body>
</html>`;

        // --- INITIALIZATION ---
        window.addEventListener('load', function() {
            try {
                // Initialize Elements
                editor = document.getElementById('code-editor');
                preview = document.getElementById('preview-frame');
                charCount = document.getElementById('char-count');
                toastEl = document.getElementById('toast-msg');
                toastBody = document.getElementById('toast-body-text');
                loadingOverlay = document.getElementById('loading-overlay');
                loadingText = document.getElementById('loading-text');
                projectStatus = document.getElementById('project-status');
                autosaveStatus = document.getElementById('autosave-status');

                // Initialize Bootstrap
                if (typeof bootstrap !== 'undefined' && toastEl) {
                    bsToast = new bootstrap.Toast(toastEl);
                } else {
                    console.warn("Bootstrap JS not loaded or Toast element missing");
                }

                // Initialize Event Listeners
                if (editor) {
                    editor.addEventListener('input', updatePreview);
                    editor.addEventListener('keydown', (e) => {
                        if (e.key === 'Tab') {
                            e.preventDefault();
                            const start = editor.selectionStart;
                            const end = editor.selectionEnd;
                            editor.value = editor.value.substring(0, start) + "  " + editor.value.substring(end);
                            editor.selectionStart = editor.selectionEnd = start + 2;
                            updatePreview();
                        }
                    });
                }

                // Check URL Params
                const params = new URLSearchParams(window.location.search);
                const viewMode = params.get('view') === '1';
                const id = params.get('id');
                const hash = window.location.hash;

                // Routing
                if (id) {
                    loadFromCloud(id, viewMode);
                } else if (viewMode && hash) {
                    const decoded = decode(hash);
                    if (decoded) {
                        document.open();
                        document.write(decoded);
                        document.close();
                    } else {
                        hideLoading();
                        document.body.style.display = 'flex';
                    }
                } else if (hash && hash.length > 1) {
                    hideLoading();
                    const decoded = decode(hash);
                    editor.value = decoded || DEFAULT_CODE;
                    updatePreview();
                    document.body.style.display = 'flex';
                } else {
                    // New Project / Local Restore
                    hideLoading();
                    
                    // Restore from Autosave if available and default code is present
                    const localSaved = localStorage.getItem(AUTOSAVE_KEY);
                    if (localSaved) {
                        editor.value = localSaved;
                        showToast('Restored from local autosave');
                    } else {
                        editor.value = DEFAULT_CODE;
                    }
                    
                    updatePreview();
                    document.body.style.display = 'flex';
                }

            } catch (e) {
                console.error("Initialization error:", e);
                // Emergency Fallback
                if (document.getElementById('loading-overlay')) {
                    document.getElementById('loading-overlay').style.display = 'none';
                }
                document.body.style.display = 'flex';
                alert("Aplikasi mengalami masalah inisialisasi: " + e.message);
            }
        });
    </script>
</body>
</html>
