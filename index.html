<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SheetRocket - Cloud Editor</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <style>
        :root {
            --editor-bg: #1e1e1e;
            --editor-text: #d4d4d4;
            --border-color: #343a40;
        }

        body {
            background-color: #212529;
            font-family: 'Inter', sans-serif;
            height: 100vh;
            overflow: hidden;
            display: none; /* Disembunyikan saat inisialisasi */
            flex-direction: column;
            color: #f8f9fa;
        }

        /* Navbar Customization */
        .navbar {
            background-color: #1a1d20 !important;
            border-bottom: 1px solid var(--border-color);
            padding: 0.75rem 1.5rem;
            flex-shrink: 0;
        }

        .brand-icon {
            width: 40px;
            height: 40px;
            /* Gradient combining Green (Sheets) and Blue/Cyan (Sky/Rocket) */
            background: linear-gradient(135deg, #198754, #0dcaf0); 
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: 0 0 15px rgba(13, 202, 240, 0.3);
        }

        /* Main Layout */
        .workspace {
            flex: 1;
            display: flex;
            overflow: hidden;
            position: relative;
        }

        .pane {
            width: 50%;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .editor-pane {
            background-color: var(--editor-bg);
            border-right: 1px solid var(--border-color);
        }

        .preview-pane {
            background-color: white;
        }

        /* Pane Header */
        .pane-header {
            padding: 8px 16px;
            font-size: 0.85rem;
            font-family: 'JetBrains Mono', monospace;
            color: #adb5bd;
            background-color: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preview-pane .pane-header {
            background-color: #f8f9fa;
            color: #6c757d;
            border-bottom: 1px solid #dee2e6;
        }

        /* Editor Area */
        #code-editor {
            flex: 1;
            width: 100%;
            background-color: var(--editor-bg);
            color: var(--editor-text);
            border: none;
            resize: none;
            padding: 1.5rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            line-height: 1.6;
            outline: none;
        }

        #code-editor::placeholder {
            color: #6c757d;
        }

        /* Preview Iframe */
        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Loading Overlay */
        #loading-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #212529;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            color: white;
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
            margin-bottom: 1rem;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .workspace {
                flex-direction: column;
            }
            .pane {
                width: 100%;
                height: 50%;
            }
            .editor-pane {
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        ::-webkit-scrollbar-track {
            background: var(--editor-bg);
        }
        ::-webkit-scrollbar-thumb {
            background: #495057;
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6c757d;
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "lucide-react": "https://esm.sh/lucide-react@^0.562.0",
    "react/": "https://esm.sh/react@^19.2.3/",
    "@google/genai": "https://esm.sh/@google/genai@^1.34.0"
  }
}
</script>
</head>
<body>

    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="spinner-border text-info" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <h5 id="loading-text">Launching SheetRocket...</h5>
    </div>

    <!-- Header -->
    <nav class="navbar navbar-dark">
        <div class="container-fluid p-0">
            <div class="d-flex align-items-center gap-3">
                <div class="brand-icon">
                    <!-- Rocket Icon for the new Brand -->
                    <i class="bi bi-rocket-takeoff-fill fs-5"></i>
                </div>
                <div>
                    <h6 class="m-0 fw-bold text-white text-uppercase" style="letter-spacing: 0.5px;">SheetRocket <span class="badge bg-secondary bg-opacity-50 border border-secondary border-opacity-50 ms-2" style="font-size: 0.6em; vertical-align: middle;">BETA</span></h6>
                    <small class="text-secondary" style="font-size: 11px;" id="project-status">Powered by Google Sheets</small>
                </div>
            </div>
            
            <div class="d-flex gap-2">
                <button onclick="saveToCloud()" class="btn btn-success btn-sm d-flex align-items-center gap-2 shadow-sm" id="btn-save" title="Save to Google Sheets">
                    <i class="bi bi-cloud-check-fill"></i> <span class="d-none d-sm-inline">Save</span>
                </button>
                <div class="vr bg-secondary mx-1 opacity-25"></div>
                <button onclick="deployPage()" class="btn btn-outline-info btn-sm d-flex align-items-center gap-2 text-white" title="Open View Mode">
                    <i class="bi bi-window-fullscreen"></i> <span class="d-none d-sm-inline">Deploy</span>
                </button>
                <button onclick="shareLink()" class="btn btn-primary btn-sm d-flex align-items-center gap-2 shadow-sm" title="Share URL">
                    <i class="bi bi-share-fill"></i> Share
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Workspace -->
    <div class="workspace">
        <!-- Editor Column -->
        <div class="pane editor-pane">
            <div class="pane-header">
                <div class="d-flex align-items-center gap-2">
                    <i class="bi bi-filetype-html"></i>
                    <span>index.html</span>
                </div>
                <span id="char-count">0 chars</span>
            </div>
            <textarea id="code-editor" spellcheck="false" placeholder="<!-- Start coding your masterpiece here... -->"></textarea>
        </div>

        <!-- Preview Column -->
        <div class="pane preview-pane">
            <div class="pane-header">
                <span class="fw-bold"><i class="bi bi-eye-fill me-2"></i>Preview</span>
                <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 d-flex align-items-center gap-1">
                    <i class="bi bi-circle-fill" style="font-size: 6px;"></i> Live
                </span>
            </div>
            <iframe id="preview-frame" sandbox="allow-scripts allow-modals allow-forms allow-popups allow-same-origin"></iframe>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="position-fixed bottom-0 start-50 translate-middle-x p-3" style="z-index: 1050">
        <div id="toast-msg" class="toast align-items-center text-white bg-success border-0 shadow-lg" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body d-flex align-items-center gap-2" id="toast-body-text">
                    Action successful!
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- App Logic -->
    <script>
        // --- CONFIGURATION ---
        // Link Web App Anda (diperbarui sesuai request)
        const APP_URL = "https://script.google.com/macros/s/AKfycbw_NrRwHRt_x8UlsQCKIddB6WXjA_kodlh77OliuuW5MeQMsdoNzUuDfVmvPx5NLlFk7g/exec";

        // --- UTILITIES ---
        const encode = (str) => {
            try { return btoa(unescape(encodeURIComponent(str))); } catch(e) { return ''; }
        };
        const decode = (hash) => {
            try { return decodeURIComponent(escape(atob(hash.replace(/^#/, '')))); } catch(e) { return ''; }
        };

        // --- DOM ELEMENTS ---
        const editor = document.getElementById('code-editor');
        const preview = document.getElementById('preview-frame');
        const charCount = document.getElementById('char-count');
        const toastEl = document.getElementById('toast-msg');
        const toastBody = document.getElementById('toast-body-text');
        const bsToast = new bootstrap.Toast(toastEl);
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        const projectStatus = document.getElementById('project-status');

        // --- STATE ---
        let currentCloudId = null;

        // --- DEFAULT CODE ---
        const DEFAULT_CODE = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SheetRocket Page</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: linear-gradient(135deg, #f0f2f5 0%, #e9ecef 100%); display: flex; align-items: center; justify-content: center; min-height: 100vh; font-family: sans-serif; }
        .card { border: none; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-radius: 16px; overflow: hidden; }
        .card-header { background: white; border-bottom: 1px solid #f0f0f0; padding: 2rem; }
        .icon-box { width: 80px; height: 80px; background: linear-gradient(135deg, #198754, #0dcaf0); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; color: white; font-size: 2.5rem; }
    </style>
</head>
<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card text-center">
                    <div class="card-body p-5">
                        <div class="icon-box"><i class="bi bi-rocket-takeoff"></i></div>
                        <h2 class="fw-bold text-dark mb-3">Hello, SheetRocket!</h2>
                        <p class="text-secondary mb-4">This page is stored in a Google Sheet and deployed instantly. Edit me to build something cool!</p>
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary btn-lg rounded-pill" onclick="alert('Ready for liftoff!')">Launch Action</button>
                        </div>
                    </div>
                    <div class="card-footer bg-light p-3 text-muted small">
                        Built with Bootstrap 5 & Apps Script
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Bootstrap Icons via CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
</body>
</html>`;

        // --- CORE FUNCTIONS ---

        const updatePreview = () => {
            const code = editor.value;
            preview.srcdoc = code;
            charCount.textContent = code.length + ' chars';
        };

        const showToast = (msg, isError = false) => {
            toastBody.textContent = msg;
            toastEl.classList.remove('bg-success', 'bg-danger');
            toastEl.classList.add(isError ? 'bg-danger' : 'bg-success');
            bsToast.show();
        };

        const showLoading = (msg) => {
            loadingText.textContent = msg;
            loadingOverlay.style.display = 'flex';
        };

        const hideLoading = () => {
            loadingOverlay.style.display = 'none';
        };

        // --- GOOGLE SHEETS INTERACTION ---

        const saveToCloud = () => {
            const code = editor.value;
            const btn = document.getElementById('btn-save');
            const originalBtnText = btn.innerHTML;
            
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
            btn.disabled = true;

            // Panggil fungsi Server-Side (Code.gs)
            if (typeof google !== 'undefined' && google.script) {
                google.script.run
                    .withSuccessHandler((id) => {
                        currentCloudId = id;
                        
                        // Update UI
                        btn.innerHTML = originalBtnText;
                        btn.disabled = false;
                        projectStatus.textContent = "Saved to Sheet (ID: " + id + ")";
                        projectStatus.classList.add('text-success');
                        
                        // Update URL (Browser History hanya untuk navigasi visual di iframe)
                        const newUrl = updateQueryString('id', id);
                        window.history.pushState({path: newUrl}, '', newUrl);
                        
                        showToast('Project saved securely to Google Sheets!');
                    })
                    .withFailureHandler((err) => {
                        btn.innerHTML = originalBtnText;
                        btn.disabled = false;
                        console.error(err);
                        showToast('Failed to save: ' + err.message, true);
                    })
                    .saveProject(code);
            } else {
                // Fallback untuk local dev testing
                setTimeout(() => {
                    btn.innerHTML = originalBtnText;
                    btn.disabled = false;
                    showToast('Simulation: Saved (Local Mode)', false);
                    currentCloudId = "LOCAL_DEV";
                    const newUrl = updateQueryString('id', 'LOCAL_DEV');
                    window.history.pushState({path: newUrl}, '', newUrl);
                }, 1000);
            }
        };

        const loadFromCloud = (id, isViewMode) => {
            showLoading("Retrieving from Google Sheets...");
            
            if (typeof google !== 'undefined' && google.script) {
                google.script.run
                    .withSuccessHandler((content) => {
                        if (content) {
                            if (isViewMode) {
                                // Direct render for view mode
                                document.open();
                                document.write(content);
                                document.close();
                                hideLoading(); // Might not be seen if doc is replaced
                            } else {
                                // Editor mode
                                editor.value = content;
                                currentCloudId = id;
                                projectStatus.textContent = "Loaded from Sheet (ID: " + id + ")";
                                updatePreview();
                                hideLoading();
                                document.body.style.display = 'flex';
                            }
                        } else {
                            hideLoading();
                            alert("Project ID not found in database.");
                            document.body.style.display = 'flex';
                        }
                    })
                    .withFailureHandler((err) => {
                        hideLoading();
                        showToast("Error loading project: " + err.message, true);
                        document.body.style.display = 'flex';
                    })
                    .loadProject(id);
            } else {
                hideLoading();
                editor.value = "<!-- Local Dev Mode: Cannot load real data -->\n" + DEFAULT_CODE;
                updatePreview();
                document.body.style.display = 'flex';
            }
        };

        // --- URL HELPERS ---

        const updateQueryString = (key, value) => {
            const url = new URL(window.location.href);
            url.searchParams.set(key, value);
            // Remove hash if we are switching to Cloud ID system to avoid confusion
            if(key === 'id') url.hash = ''; 
            return url.toString();
        };

        const getBaseUrl = () => {
            // Gunakan APP_URL yang di-hardcode jika ada (Best Practice untuk GAS)
            if (APP_URL && APP_URL.startsWith('http')) {
                return APP_URL;
            }
            // Fallback ke window.location (biasanya URL sandbox)
            return window.location.href.split('?')[0].split('#')[0];
        };

        const shareLink = async () => {
            const baseUrl = getBaseUrl();
            let finalUrl = baseUrl;
            
            // Prioritize Cloud ID link if available
            if (currentCloudId) {
                 finalUrl = `${baseUrl}?id=${currentCloudId}`;
            } else {
                // Fallback to Hash encoding if not saved
                const hash = encode(editor.value);
                finalUrl = `${baseUrl}#${hash}`;
                // Set hash locally for user visual feedback
                window.location.hash = hash;
            }

            try {
                await navigator.clipboard.writeText(finalUrl);
                showToast('Link copied: ' + (currentCloudId ? 'SheetRocket Link' : 'Hash Link'));
            } catch (err) {
                prompt("Copy this link:", finalUrl);
            }
        };

        const deployPage = () => {
            const baseUrl = getBaseUrl();
            let url;
            
            if (currentCloudId) {
                // Deploy via ID (Clean URL)
                url = `${baseUrl}?view=1&id=${currentCloudId}`;
            } else {
                // Deploy via Hash
                const hash = encode(editor.value);
                url = `${baseUrl}?view=1#${hash}`;
            }
            window.open(url, '_blank');
        };

        // --- INITIALIZATION ---

        (function init() {
            const params = new URLSearchParams(window.location.search);
            const viewMode = params.get('view') === '1';
            const id = params.get('id');
            const hash = window.location.hash;

            // Scenario 1: Load from Cloud ID (View or Edit)
            if (id) {
                loadFromCloud(id, viewMode);
                return;
            }

            // Scenario 2: Legacy View Mode (Hash)
            if (viewMode && hash) {
                const decoded = decode(hash);
                if (decoded) {
                    document.open();
                    document.write(decoded);
                    document.close();
                    return;
                }
            }
            
            // Scenario 3: Legacy Edit Mode (Hash)
            if (hash && hash.length > 1) {
                hideLoading();
                const decoded = decode(hash);
                editor.value = decoded || DEFAULT_CODE;
                updatePreview();
                document.body.style.display = 'flex';
                return;
            }

            // Scenario 4: New Project
            hideLoading();
            editor.value = DEFAULT_CODE;
            updatePreview();
            document.body.style.display = 'flex';
        })();

        // --- EVENT LISTENERS ---
        if (editor) {
            editor.addEventListener('input', updatePreview);
            editor.addEventListener('keydown', (e) => {
                if (e.key === 'Tab') {
                    e.preventDefault();
                    const start = editor.selectionStart;
                    const end = editor.selectionEnd;
                    editor.value = editor.value.substring(0, start) + "  " + editor.value.substring(end);
                    editor.selectionStart = editor.selectionEnd = start + 2;
                    updatePreview();
                }
            });
        }
    </script>
</body>
</html>
